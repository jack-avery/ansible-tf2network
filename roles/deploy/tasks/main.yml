---
- name: Perform setup
  ansible.builtin.include_tasks: setup.yml

- name: Announce update
  ignore_errors: true
  rcon:
    address: "{{ ansible_host }}"
    port: "{{ item.port }}"
    password: "{{ item.secrets.rcon_pass }}"
    command: 'sm_csay Server is restarting for updates.;sm_say Server is restarting for updates.'
  loop: "{{ targets.instances }}"
  loop_control:
    index_var: loop0
  delegate_to: localhost
  timeout: 10

- name: Create Podman network
  containers.podman.podman_network:
    name: net-{{ network_shortname }}
    state: quadlet
    quadlet_options:
      - |
        [Install]
        WantedBy=ansible-tf2network_{{ network_shortname }}.service multi-user.target default.target

- name: Template kube.j2
  ansible.builtin.template:
    src: "kube.yaml.j2"
    dest: "~/{{ network_shortname }}.yaml"
    mode: 0755

- name: Template quadlet.j2
  ansible.builtin.template:
    src: "quadlet.kube.j2"
    dest: "~/.config/containers/systemd/ansible-tf2network_{{ network_shortname }}.kube"
    mode: 0755

- name: systemd user daemon reload
  ansible.builtin.systemd_service:
    scope: user
    daemon_reload: true

- name: Install restart cronjob
  ansible.builtin.cron:
    name: "srcds-restart-{{ network_shortname }}"
    weekday: "*"
    minute: "0"
    hour: "{{ daily_restart_hour_utc }}"
    job: "podman pod restart ansible-tf2network_{{ network_shortname }}"

- name: Copy updater script
  copy:
    src: updater.sh
    dest: /home/tf2server/updater.sh
    mode: 0744

- name: Install autoupdate cronjob
  ansible.builtin.cron:
    name: "ansible-tf2network: autoupdater"
    weekday: "*"
    minute: "*/10"
    hour: "*"
    job: "/home/tf2server/updater.sh >> /home/tf2server/updater.log"
