apiVersion: v1
kind: Pod
metadata:
  name: ansible-tf2network_{{ network_shortname }}
spec:
  containers:
{% for item in targets.instances %}
    - name: "srcds-{{ network_shortname }}-{{ item.name }}"
      image: "srcds-{{ network_shortname }}-{{ item.name }}:latest"
      ports:
        - containerPort: {{ item.port }}
          hostPort: {{ item.port }}
          protocol: TCP
        - containerPort: {{ item.port }}
          hostPort: {{ item.port }}
          protocol: UDP
        - containerPort: {{ item.port + 5 }}
          hostPort: {{ item.port + 5}}
          protocol: UDP
      args:
        - -cpus
        - "1"
{% endfor %}
{% if not targets.is_metrics %}
    - name: "ssh-{{ network_shortname }}"
      image: docker.io/kroniak/ssh-client
      restart: always
      volumes:
        - "/home/tf2server/.ssh/sbpp_key_{{ network_shortname }}:/root/id_rsa"
      command:
        - ssh
        - -4NTCp
        - "{{ sbpp_host_ssh_port }}"
        - -i
        - /root/id_rsa
        - -o
        - StrictHostKeyChecking=no
        - -o
        - ServerAliveInterval=60
        - -o
        - ExitOnForwardFailure=yes
        - -L
        - "0.0.0.0:3306:db:3306"
        - "sbpp_user@{{ sbpp_host }}"
{% endif %}
