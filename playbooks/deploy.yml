---
- name: Generate restart cronjob and install
  hosts: tf2
  tasks:
    - name: Load secrets
      ansible.builtin.include_tasks: secrets.yml

    - name: Announce update
      ignore_errors: true
      rcon:
        address: "{{ inventory_hostname }}"
        port: "{{ srcds_base_port + (loop0 * srcds_reserve_ports) }}"
        password: "{{ item.rcon_pass }}"
        command: 'sm_csay Server is restarting for updates.;sm_say Server is restarting for updates.'
      loop: "{{ instances_secrets }}"
      loop_control:
        index_var: loop0
      delegate_to: localhost

    - name: Start
      community.docker.docker_container:
        name: "srcds-{{ item.name }}"
        image: "srcds-{{ item.name }}:latest"
        state: started
        auto_remove: true
      loop: "{{ instances }}"
      loop_control:
        index_var: loop0
